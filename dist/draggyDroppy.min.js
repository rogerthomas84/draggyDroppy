$.fn.draggyDroppy=function(e){void 0===e&&(e={});let a={uploadUrl:"/",uploadParams:{},wrapperClass:"draggyDropArea",formClass:"draggyDropForm",highlightClass:"draggyOn",intro:$("<p />").html('Drag and drop your files below or click "Select files".'),fileElemClass:"draggyFileElem",accept:"*/*",showProgress:!0,progressBarClass:"draggyProgressBar",listClass:"draggyList",multiple:!0,triggerContent:"Select files",triggerClass:"btn btn-primary",showErrorMessage:!0,errorMessageClass:"draggyErrorReason",errorMessageTemplate:"Upload failed. Response code %s.",onStart:function(){},onComplete:function(){},onFileFinished:function(e,a,t,s){}};$.extend(a,e);let t=0,s=0,r=function(){let e="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789",t=a.length;for(let s=0;s<32;s++)e+=a.charAt(Math.floor(Math.random()*t));return e};this.html(function(e){let a="draggyInput"+r(),t=$("<form />").addClass(e.formClass);null!==e.intro&&t.html(e.intro),t.append($("<input />").attr("type","file").attr("id",a).addClass(e.fileElemClass).prop("multiple",e.multiple).attr("accept",e.accept)),t.append($("<label />").addClass(e.triggerClass).attr("for",a).html(e.triggerContent));let s=$("<div />").addClass(e.wrapperClass).html(t);return!0===e.showProgress&&s.append($("<progress />").addClass(e.progressBarClass).attr("max","100").attr("value","0")),s.append($("<div />").addClass(e.listClass)),s}(a));let l=$("."+a.wrapperClass);function o(){let e=t/s*100;$("."+a.progressBarClass).val(e),t===s&&a.onComplete()}function n(e){!0===a.showProgress&&($("."+a.progressBarClass).val(0),t>0&&o());for(let a=0;a<e.length;a++){let t="draggyListIdentifier"+r();i(e[a],a,t),d(e[a],a,t)}}function d(e,t,s){$("."+a.listClass).append($("<div />").addClass("draggyItem").html(e.name).attr("data-uid",s))}function i(e,s,r){let l=a.uploadUrl,n=new XMLHttpRequest,d=new FormData;n.open("POST",l,!0),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.addEventListener("readystatechange",function(){if(4===n.readyState&&200===n.status)t++,!0===a.showProgress&&o(),$('.draggyItem[data-uid="'+r+'"]').addClass("draggyItemSuccess"),a.onFileFinished(e,n.responseText,n.status,r);else if(4===n.readyState&&200!==n.status){t++,!0===a.showProgress&&o();let s=$('.draggyItem[data-uid="'+r+'"]').addClass("draggyItemError");if(a.onFileFinished(e,n.responseText,n.status,r),!0===a.showErrorMessage){let e=a.errorMessageTemplate;-1!==e.indexOf("%s")&&(e=e.replace("%s",n.status)),s.append('<p class="'+a.errorMessageClass+'">'+e+"</span>")}}}),d.append("file",e);for(let e in a.uploadParams)a.uploadParams.hasOwnProperty(e)&&d.append(e,a.uploadParams[e]);n.send(d)}l.on("dragenter dragover dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}),$("body").on("dragenter dragover dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}),l.on("dragenter dragover",function(){$(this).addClass(a.highlightClass)}),l.on("dragleave",function(){$(this).removeClass(a.highlightClass)}),l.on("drop",function(e){$(this).removeClass(a.highlightClass),function(e){a.onStart();let t=e.originalEvent.dataTransfer.files,r=[];for(let e=0;e<t.length;e++)r.push(t.item(e));s+=r.length,n(r)}(e)}),$("."+a.fileElemClass).on("change",function(e){e.preventDefault();let t=$(this).prop("files");t.length>0&&function(e){a.onStart(),s+=e.length,n(e)}(t)})};
